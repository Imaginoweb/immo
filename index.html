<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Clienteling</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f3f4f6;
      --card: #ffffff;
      --primary: #003c71; /* bleu un peu corpo */
      --primary-soft: rgba(0,60,113,0.12);
      --text: #0f172a;
      --muted: #6b7280;
      --radius: 1.25rem;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    header {
      background: #fff;
      border-bottom: 1px solid rgba(15,23,42,0.05);
      padding: 1rem 1.5rem;
      display: flex;
      gap: 1rem;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 30;
    }
    .app-title {
      font-weight: 700;
      letter-spacing: -0.01em;
    }
    .search-wrapper {
      position: relative;
      max-width: 420px;
      width: 100%;
    }
    .search-input {
      width: 100%;
      padding: 0.65rem 0.75rem 0.65rem 2.4rem;
      border: 1px solid rgba(15,23,42,0.08);
      border-radius: 9999px;
      background: #fff;
      font-size: 0.9rem;
      outline: none;
      transition: border 0.15s ease;
    }
    .search-input:focus {
      border: 1px solid rgba(0,60,113,0.45);
      box-shadow: 0 10px 30px rgba(0,60,113,0.12);
      background: #fff;
    }
    .search-icon {
      position: absolute;
      left: 0.8rem;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
      font-size: 0.9rem;
      color: #94a3b8;
    }
    .dropdown {
      position: absolute;
      top: 2.8rem;
      left: 0;
      right: 0;
      background: #fff;
      border: 1px solid rgba(15,23,42,0.06);
      border-radius: 1.25rem;
      box-shadow: 0 18px 45px rgba(15,23,42,0.08);
      max-height: 360px;
      overflow-y: auto;
      z-index: 40;
      display: none;
    }
    .dropdown-item {
      padding: 0.6rem 0.85rem 0.55rem 0.85rem;
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
      cursor: pointer;
      transition: background 0.12s ease;
    }
    .dropdown-item:hover {
      background: rgba(0,60,113,0.04);
    }
    .dropdown-title { font-weight: 600; }
    .dropdown-sub {
      font-size: 0.7rem;
      color: #94a3b8;
    }

    main {
      display: grid;
      grid-template-columns: 340px 1fr;
      gap: 1.5rem;
      padding: 1.5rem;
    }
    @media (max-width: 980px) {
      main {
        grid-template-columns: 1fr;
      }
      .search-wrapper {
        max-width: 100%;
      }
    }

    .panel {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: 0 10px 40px rgba(15,23,42,0.04);
      border: 1px solid rgba(15,23,42,0.03);
      padding: 1rem;
    }
    .client-header {
      display: flex;
      gap: 1rem;
      align-items: center;
      margin-bottom: 1rem;
    }
    .avatar {
      width: 58px;
      height: 58px;
      border-radius: 1.15rem;
      background: rgba(0,60,113,0.12);
      display: grid;
      place-items: center;
      font-weight: 700;
      color: #fff;
      font-size: 1.35rem;
    }
    .badge-projet {
      background: rgba(0,60,113,0.08);
      color: #0f172a;
      font-size: 0.6rem;
      padding: 0.25rem 0.5rem;
      border-radius: 999px;
      text-transform: uppercase;
      letter-spacing: .04em;
    }
    h2 {
      margin: 0;
      font-size: 1.1rem;
    }
    .muted { color: var(--muted); font-size: 0.8rem; }
    .section-title {
      font-weight: 600;
      font-size: 0.78rem;
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      color: #475569;
      letter-spacing: 0.03em;
    }
    .info-grid {
      display: grid;
      grid-template-columns: repeat(2,minmax(0,1fr));
      gap: 0.45rem 1rem;
    }
    @media (max-width: 580px) {
      .info-grid {
        grid-template-columns: 1fr;
      }
    }
    .info-row {
      display: flex;
      flex-direction: column;
      gap: 0.1rem;
    }
    .label { font-size: 0.65rem; color: #94a3b8; text-transform: uppercase; }
    .value { font-size: 0.9rem; font-weight: 500; }
    .agent-card {
      background: rgba(0,60,113,0.04);
      border-radius: 1rem;
      padding: 0.6rem 0.7rem 0.7rem;
    }
    .optin-list {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .optin-pill {
      padding: 0.25rem 0.55rem 0.3rem;
      border-radius: 999px;
      font-size: 0.65rem;
      display: flex;
      gap: 0.3rem;
      align-items: center;
    }
    .yes { background: rgba(34,197,94,0.12); color: #166534; }
    .no { background: rgba(248,113,113,0.08); color: #b91c1c; }
    .actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
      flex-wrap: wrap;
    }
    .btn {
      background: var(--primary);
      border: none;
      color: #fff;
      padding: 0.45rem 0.7rem 0.5rem;
      border-radius: 0.85rem;
      font-size: 0.7rem;
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      cursor: pointer;
    }
    .btn.secondary {
      background: rgba(0,60,113,0.06);
      color: #0f172a;
    }
    .empty-state {
      text-align: center;
      padding: 2.5rem 1rem;
      color: #94a3b8;
    }
  </style>
</head>
<body>
  <header>
    <div class="app-title">Clienteling PICHET ¬∑ RCU</div>
    <div class="search-wrapper">
      <span class="search-icon">üîé</span>
      <input id="searchInput" class="search-input" placeholder="Rechercher (nom, pr√©nom, email)..." autocomplete="off" />
      <div id="searchDropdown" class="dropdown"></div>
    </div>
  </header>

  <main>
    <!-- Colonne de gauche : infos rapides -->
    <aside class="panel" id="leftPanel">
      <div class="section-title">Dernier contact</div>
      <p class="muted" style="margin-top:0;">S√©lectionnez un contact √† gauche pour afficher le d√©tail.</p>
      <div class="section-title" style="margin-top:1.5rem;">Raccourcis</div>
      <div class="actions">
        <button class="btn secondary" onclick="alert('TODO: cr√©er une opportunit√© dans Pichet')">+ Nouvelle opportunit√©</button>
        <button class="btn secondary" onclick="alert('TODO: ajouter une note')">+ Ajouter une note</button>
      </div>
    </aside>

    <!-- Colonne de droite : fiche client -->
    <section class="panel" id="clientPanel">
      <div id="emptyState" class="empty-state">
        üîé Recherchez ‚Äúmichel‚Äù : la fiche de <strong>Michel Martin</strong> s‚Äôaffichera ici.
      </div>
      <div id="clientContent" style="display:none;">
        <div class="client-header">
          <div class="avatar" id="avatarInitials">MM</div>
          <div>
            <h2 id="clientName">‚Äî</h2>
            <div class="muted" id="clientEmail">‚Äî</div>
            <div class="badge-projet" id="badgeProjet" style="display:none;"></div>
          </div>
        </div>

        <div style="margin-bottom:1.1rem;">
          <div class="section-title">Coordonn√©es</div>
          <div class="info-grid">
            <div class="info-row">
              <span class="label">T√©l√©phone</span>
              <span class="value" id="clientTel">‚Äî</span>
            </div>
            <div class="info-row">
              <span class="label">Canal pr√©f√©r√©</span>
              <span class="value" id="canalPref">‚Äî</span>
            </div>
            <div class="info-row" style="grid-column:1/-1;">
              <span class="label">Adresse</span>
              <span class="value" id="clientAddress">‚Äî</span>
            </div>
          </div>
        </div>

        <div style="margin-bottom:1.1rem;">
          <div class="section-title">Projet immobilier</div>
          <div class="info-grid">
            <div class="info-row">
              <span class="label">Projet actuel</span>
              <span class="value" id="projetActuel">‚Äî</span>
            </div>
            <div class="info-row">
              <span class="label">Villes d'int√©r√™t</span>
              <span class="value" id="villesInterets">‚Äî</span>
            </div>
            <div class="info-row">
              <span class="label">Dernier achat</span>
              <span class="value" id="dernierAchat">‚Äî</span>
            </div>
          </div>
        </div>

        <div style="margin-bottom:1.1rem;">
          <div class="section-title">Agent Pichet</div>
          <div class="agent-card">
            <div class="value" id="nomAgent">‚Äî</div>
            <div class="muted" id="telAgent">‚Äî</div>
            <div class="muted" id="agenceLiee">‚Äî</div>
          </div>
        </div>

        <div>
          <div class="section-title">Consentements</div>
          <div class="optin-list" id="optins"></div>
        </div>

        <div class="actions">
          <button class="btn" onclick="alert('TODO: envoyer un email depuis Imagino / hub interne')">üìß Contacter</button>
          <button class="btn secondary" onclick="alert('TODO: cr√©er suivi visite')">üìù Planifier une visite</button>
        </div>
      </div>
    </section>
  </main>

  <script>
    const API_BASE_URL = "https://francois-sandbox.saas.imagino.com/ucdapi/API_RCU_Pichet/1/RCU_immo_Contacts";
    const API_KEY = "0cfe1225-a2f7-43b9-9645-caebdaf5a971";
    let ALL_CONTACTS = [];

    const searchInput = document.getElementById("searchInput");
    const dropdown = document.getElementById("searchDropdown");

    async function loadContacts() {
      try {
        const url = API_BASE_URL + "?limit=1000";
        const res = await fetch(url, {
          headers: {
            "X-API-KEY": API_KEY
          }
        });
        if (!res.ok) {
          console.error("Erreur API", res.status);
          return;
        }
        const json = await res.json();
        ALL_CONTACTS = json.data || [];
        // auto-s√©lection de Michel Martin si pr√©sent
        const michel = ALL_CONTACTS.find(c =>
          (c.firstName && c.firstName.toLowerCase() === "michel") &&
          (c.lastName && c.lastName.toLowerCase().includes("martin"))
        );
        if (michel) {
          renderClient(michel);
        }
      } catch (e) {
        console.error("Erreur chargement contacts", e);
      }
    }

    function filterContacts(term) {
      const t = term.toLowerCase();
      return ALL_CONTACTS.filter(c => {
        const fn = (c.firstName || "").toLowerCase();
        const ln = (c.lastName || "").toLowerCase();
        const em = (c.email || "").toLowerCase();
        return fn.includes(t) || ln.includes(t) || em.includes(t);
      }).slice(0, 30);
    }

    function renderDropdown(items) {
      if (!items.length) {
        dropdown.style.display = "none";
        return;
      }
      dropdown.innerHTML = "";
      items.forEach(c => {
        const div = document.createElement("div");
        div.className = "dropdown-item";
        const fullName = (c.firstName || "") + " " + (c.lastName || "");
        div.innerHTML = `
          <span class="dropdown-title">${fullName.trim() || "(sans nom)"}</span>
          <span class="dropdown-sub">${c.email || "‚Äî"}${c.city ? " ¬∑ " + c.city : ""}</span>
        `;
        div.addEventListener("click", () => {
          renderClient(c);
          dropdown.style.display = "none";
          searchInput.value = fullName.trim();
        });
        dropdown.appendChild(div);
      });
      dropdown.style.display = "block";
    }

    function renderClient(c) {
      document.getElementById("emptyState").style.display = "none";
      document.getElementById("clientContent").style.display = "block";

      const name = ((c.firstName || "") + " " + (c.lastName || "")).trim() || "(Sans nom)";
      document.getElementById("clientName").textContent = name;
      document.getElementById("clientEmail").textContent = c.email || "‚Äî";
      document.getElementById("clientTel").textContent = c.telephone || "‚Äî";
      document.getElementById("canalPref").textContent = c.Canal_prefere || "‚Äî";

      const addrParts = [c.addressLine, c.zipCode, c.city, c.country].filter(Boolean);
      document.getElementById("clientAddress").textContent = addrParts.join(", ") || "‚Äî";

      document.getElementById("projetActuel").textContent = c.Projet_actuel || "‚Äî";
      document.getElementById("villesInterets").textContent = c.Ville_d_interets || "‚Äî";
      document.getElementById("dernierAchat").textContent = c.Dernier_achat || "‚Äî";

      document.getElementById("nomAgent").textContent = c.Nom_Agent || "‚Äî";
      document.getElementById("telAgent").textContent = c.Tel_agent ? "üìû " + c.Tel_agent : "‚Äî";
      document.getElementById("agenceLiee").textContent = c.Agence_liee ? "Agence : " + c.Agence_liee : "";

      // badge projet
      const badge = document.getElementById("badgeProjet");
      if (c.Projet_actuel) {
        badge.textContent = c.Projet_actuel;
        badge.style.display = "inline-block";
      } else {
        badge.style.display = "none";
      }

      // avatar
      const initials = (c.firstName ? c.firstName[0] : "") + (c.lastName ? c.lastName[0] : "");
      document.getElementById("avatarInitials").textContent = initials ? initials.toUpperCase() : "CL";

      // optins
      const optinsEl = document.getElementById("optins");
      optinsEl.innerHTML = "";
      const optins = [
        { label: "G√©n√©ral", val: c.optIn },
        { label: "Email", val: c.optInEmail },
        { label: "SMS", val: c.optInSMS },
        { label: "Push", val: c.optInPush },
        { label: "Print", val: c.optInPrint }
      ];
      optins.forEach(o => {
        if (o.val === undefined) return;
        const span = document.createElement("span");
        span.className = "optin-pill " + (o.val ? "yes" : "no");
        span.textContent = o.label + ": " + (o.val ? "Oui" : "Non");
        optinsEl.appendChild(span);
      });
    }

    searchInput.addEventListener("input", (e) => {
      const term = e.target.value.trim();
      if (!term) {
        dropdown.style.display = "none";
        return;
      }
      const results = filterContacts(term);
      renderDropdown(results);
    });

    document.addEventListener("click", (e) => {
      if (!e.target.closest(".search-wrapper")) {
        dropdown.style.display = "none";
      }
    });

    loadContacts();
  </script>
</body>
</html>
